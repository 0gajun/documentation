---
title: Agent Checkの書き方
sidebar:
  nav:
    - header: Agent Checkのガイド
    - text: 概要
      href: "#overview"
    - text: セットアップ
      href: "#setup"
    - text: AgentCheckのインターフェース
      href: "#interface"
    - text: 設定
      href: "#config"
    - text: ディレクトリーの構造
      href: "#directory"
    - text: 始めてのチェック
      href: "#first"
    - text: HTTPのCheck
      href: "#http"
---

<!-- <div class="alert alert-block">
This guide requires an Agent version >= 3.2.0. Older versions of the Agent do
not include the `AgentCheck` interface that we'll be using.
</div> -->

<div class="alert alert-block">
サービスチェックを使うには、Datadog Agent 3.2.0 以降をインストールしている必要があります。 それ以前のバージョンには、AgentCheckのインターフェスは実装されていません。
</div>


<!--
======================================================
OVERVIEW
======================================================
-->

<!-- <h3 id="overview">Overview</h3>
This guide details how to collect metrics and events from a new data source
by writing an Agent Check, a Python plugin to the Datadog Agent. We'll
look at the `AgentCheck` interface, and then write a simple Agent Check
that collects timing metrics and status events from HTTP services.

Any custom checks will be included in the main check run loop, meaning
they will run every check interval, which defaults to 15 seconds. -->


<h3 id="overview">概要</h3>

このガイドでは、Pythonで記述したDatadog Agent のpluginであるAgent Check を述することで、新しいデータソースからのメトリックスとイベント情報を収集する方法について説明します。
`AgentCheck`のインターフェースを確認した後、HTTP サービスからタイミング・メトリックスやステータスに関するイベント情報を収集する簡単なAgent Checkを記述してみます。

Agent Checkは、メインチェックの実行ループに組み込まれ、デフォルト設定では15秒間隔で実行されます。


<!--
======================================================
SETUP
======================================================
-->

<!-- <h3 id="setup">Setup</h3>

First off, ensure you've properly
<a href="http://app.datadoghq.com/account/settings#agent">installed the
Agent</a> on your machine. If you run into any issues during the setup, pop by
our chatroom, <a href="irc://irc.freenode.net/datadog">#datadog on FreeNode</a>,
and we'll be happy to answer any questions you might have. (There's a
<a href="http://webchat.freenode.net/?randomnick=1&channels=datadog&prompt=1">
web chat client, too</a>.) -->

<h3 id="setup">セットアップ</h3>

未だDatadog Agentをインストールしていない場合は、[Datadog Agent 入門](../basic_agent_usage/)又は、ダッシュボード内タブを[Installations -> Agent](http://app.datadoghq.com/account/settings#agent)とクリックしたインストールドキュメントを参照してください。これらのドキュメントでは、特定のOS用のDatadog Agent のインストールする手順を解説しています。

セットアップ中に問題が発生した場合は、[freenode にあるDatadog](irc://irc.freenode.net/datadog)のチャットルームで気兼ねなく質問してください。 ([web チャットクライアント](http://webchat.freenode.net/?randomnick=1&channels=datadog&prompt=1))


<!--
======================================================
INTERFACE
======================================================
-->

<!-- <h3 id="interface">Agent Check Interface</h3>

All custom checks inherit from the `AgentCheck` class found in `checks/__init__.py`
and require a `check()` method that takes one argument, `instance` which is a
`dict` having the configuration of a particular instance. The `check` method is
run once per instance defined in the check configuration (discussed later). -->

<h3 id="interface">AgentCheck のインターフェース</h3>

すべてのカスタム・チェックは、`checks/__init__.py`に記述されている`AgentCheck`クラスを継承し、`check()`関数をオーバーライドして生成します。
`check()` 関数には、そのインスタンスの構成が記述された辞書型の情報を引数に渡します。
`check()` 関数は、Check設定で定義されてたインスタンスごとに一回実行されることになります。(詳細に関しては、後に回します)


<!-- #### Sending metrics

Sending metrics in a check is easy. If you're already familiar with the
methods available in DogStatsD, then the transition will be very simple. If
you're not already familiar with that interface, you'll find sending metrics is
a breeze.

You have the following methods available to you:

<%= snippet_code_block("guides-agentchecks-methods.py") %>

All of these methods take the following arguments:

- `metric`: The name of the metric
- `value`: The value for the metric (defaults to 1 on increment, -1 on decrement)
- `tags`: (optional) A list of tags to associate with this metric.
- `hostname`: (optional) A hostname to associate with this metric. Defaults to the current host.
- `device_name`: (optional) A device name to associate with this metric.

These methods may be called from anywhere within your check logic. At the end of
your `check` function, all metrics that were submitted will be collected and
flushed out with the other Agent metrics.
 -->

#### メトリックスの送信

Agent Checkでメトリックスを送信することは非常に簡単です。既にDogStatsDのが提供している関数に精通しているなら、移行は非常に簡単です。
未だそれらの関数に慣れていない場合でも、それほど大変ではないというとことがすぐ分かるはずです。


Agent Checkでは、次のような関数を利用することができます:

<%= snippet_code_block("guides-agentchecks-methods.py") %>

全ての関数は、次の引数をとります:

- `metric`: The name of the metric
- `value`: The value for the metric (defaults to 1 on increment, -1 on decrement)
- `tags`: (optional) A list of tags to associate with this metric.
- `hostname`: (optional) A hostname to associate with this metric. Defaults to the current host.
- `device_name`: (optional) A device name to associate with this metric.

これらの関数は、チェックロジックのどこからでも呼び出すことができます。これらの関数を使って収集したメトリックスは、`check` 機能の実行の最後に他のAgent メトリックスと共にDatadogのサービスに転送されます。


<!-- #### Sending events

At any time during your check, you can make a call to `self.event(...)` with one argument: the payload of the event. Your event should be structured like this:

<%= snippet_code_block("guides-agentchecks-event.py") %>

At the end of your check, all events will be collected and flushed with the rest
of the Agent payload. -->


#### イベントの送信

チェックを実行している間は、`self.event(...)`を呼び出すことで、そのイベントの中身を見ることができます。イベントの中身は次のような構造になっている必要があります:

<%= snippet_code_block("guides-agentchecks-event.py") %>

全てのイベントは、`check` 機能の実行の最後に、他のAgent Checkの内容と共にDatadogのサービスに転送されます。


<!-- #### Exceptions

If a check cannot run because of improper configuration,  programming error or
because it could not collect any metrics, it should raise a meaningful exception.
This exception will be logged, as well as be shown in the Agent info command for
easy debugging. For example:

    $ sudo /etc/init.d/datadog-agent info

      Checks
      ======

        my_custom_check
        ---------------
          - instance #0 [ERROR]: ConnectionError('Connection refused.',)
          - Collected 0 metrics & 0 events -->

#### エラーと例外の表示

If a check cannot run because of improper configuration, programming error or
because it could not collect any metrics, it should raise a meaningful exception.
This exception will be logged, as well as be shown in the Agent info command for
easy debugging. For example:

不適切な設定、プログラミングのエラー、いずれかのメトリックスが収集できないなどで、Checkが実行できない場合はには、状況を把握しやすい例外メッセージが必要です。

チェックがあるため、不適切な設定、プログラミングエラーを実行することはできませんか、いずれかのメトリックを収集できなかったので、それは意味のある例外を発生させるかどうか。この例外はログに記録されます、だけでなく、簡単なデバッグのためのエージェントinfoコマンドで表示さ。たとえば、次のように


    $ sudo /etc/init.d/datadog-agent info

      Checks
      ======

        my_custom_check
        ---------------
          - instance #0 [ERROR]: ConnectionError('Connection refused.',)
          - Collected 0 metrics & 0 events


<!-- #### Logging

As part of the parent class, you're given a logger at `self.log`, so you can do
things like `self.log.info('hello')`. The log handler will be `checks.{name}`
where `{name}` is the name of your check (based on the filename of the check
module). -->

#### ログの保存

As part of the parent class, you're given a logger at `self.log`, so you can do
things like `self.log.info('hello')`. The log handler will be `checks.{name}`
where `{name}` is the name of your check (based on the filename of the check
module).

親クラスの一環として、あなたがでロガーを与えられているself.logあなたのようなものを行うことができるように、self.log.info（ 'こんにちは'）を。ログハンドラは次のようになりますかどうかをチェックします。{名前} {name}が（検査モジュールのファイル名に基づいて）小切手の名前です。


<!--
======================================================
CONFIGURATION
======================================================
-->

<!-- <h3 id="config">Configuration</h3>

Each check will have a configuration file that will be placed in the `conf.d`
directory. Configuration is written using [YAML](http://www.yaml.org/). The
file name should match the name of the check module (e.g.: `haproxy.py` and
`haproxy.yaml`).

The configuration file has the following structure:

<%= snippet_code_block("guides-agentchecks-config.yaml") %>

<div class="alert alert-block">Note: YAML files must use spaces instead of tabs.</div> -->

<h3 id="config">設定</h3>

Each check will have a configuration file that will be placed in the `conf.d`
directory. Configuration is written using [YAML](http://www.yaml.org/). The
file name should match the name of the check module (e.g.: `haproxy.py` and
`haproxy.yaml`).

The configuration file has the following structure:

各チェックがに置かれる設定ファイルがありますのconf.dの ディレクトリを。コンフィギュレーションは、使用して書かれているYAMLを。（：例えば、ファイル名がチェックモジュールの名前と一致する必要がありhaproxy.pyと haproxy.yamlを）。

構成ファイルには、以下の構造を有する。

<%= snippet_code_block("guides-agentchecks-config.yaml") %>

<div class="alert alert-block">Note: YAML files must use spaces instead of tabs.</div>


<!-- #### init_config

The *init_config* section allows you to have an arbitrary number of global
configuration options that will be available on every run of the check in
`self.init_config`. -->

#### init_config

The *init_config* section allows you to have an arbitrary number of global
configuration options that will be available on every run of the check in
`self.init_config`.

init_configのセクションでは、チェックインの実行ごとに利用できるようになり、グローバルコンフィギュレーションオプションを任意の数持つことができます self.init_configを。


<!-- #### instances

The *instances* section is a list of instances that this check will be run
against. Your actual `check()` method is run once per instance. This means that
every check will support multiple instances out of the box. -->

#### instances

The *instances* section is a list of instances that this check will be run
against. Your actual `check()` method is run once per instance. This means that
every check will support multiple instances out of the box.

インスタンスセクションには、このチェックがに対して実行されるインスタンスのリストです。あなたの実際のチェック（）メソッドは、インスタンスごとに一度実行されます。これは、すべてのチェックは箱から出して複数のインスタンスをサポートすることを意味します。


<!--
======================================================
DIRECTORY STRUCTURE
======================================================
-->

<h3 id="directory">Directory Structure</h3>

Before starting your first check it is worth understanding the checks directory
structure. There are two places that you will need to add files for your check.
The first is the `checks.d` folder, which lives in your Agent root.

For all Linux systems, this means you will find it at:

あなたの最初のチェックを開始する前に、それは、小切手のディレクトリ構造を理解する価値があります。あなたがチェック用のファイルを追加する必要があります2つの場所があります。最初はchecks.dのあなたのエージェントのルートに住んでいるフォルダ、。

すべてのLinuxシステムでは、これはあなたがで見つけることを意味します。


    /etc/dd-agent/checks.d/

For Windows Server >= 2008 you'll find it at:

のWindows Server> = 2008の場合には、でそれを見つけることができます：


    C:\Program Files (x86)\Datadog\Agent\checks.d\

    OR

    C:\Program Files\Datadog\Agent\checks.d\

For Mac OS X and source installations, you'll find it at:

Mac OS Xとソースインストールでは、でそれを見つけることができます：

    ~/.datadog-agent/agent/checks.d/

    OR

    ~/.pup/agent/checks.d/

    OR

    <sandbox_folder>/checks.d/

The other folder that you need to care about is `conf.d` which lives in the
Agent configuration root.

あなたが気にする必要がある他のフォルダがあるのconf.dエージェント構成のルートに住んでいます。

For Linux, you'll find it at:

Linuxの場合、あなたはでそれを見つけることができます：


    /etc/dd-agent/conf.d/

For Windows, you'll find it at:

Windowsの場合、あなたはでそれを見つけることができます：

    C:\ProgramData\Datadog\conf.d\

    OR

    C:\Documents and Settings\All Users\Application Data\Datadog\conf.d\

For Mac OS X and source installations, you'll find it at:

Mac OS Xとソースインストールでは、でそれを見つけることができます：

    ~/.datadog-agent/agent/conf.d/

    OR

    ~/.pup/agent/conf.d/

    OR

    <sandbox_folder>/conf.d/

You can also add additional checks to a single directory, and point to it in `datadog.conf`:

また、1つのディレクトリに追加のチェックを追加し、それを指すことができdatadog.conf。

    additional_checksd: /path/to/custom/checks.d/

<!--
======================================================
FIRST CHECK
======================================================
-->

<h3 id="first">Your First Check</h3>

<div class="alert alert-block">
The names of the configuration and check files must match. If your check
is called <code>mycheck.py</code> your configuration file <em>must</em> be
named <code>mycheck.yaml</code>.
</div>

設定およびチェックファイルの名前が一致している必要があります。あなたのチェックが呼び出された場合mycheck.pyあなたの設定ファイルがなければならないということmycheck.yaml。


To start off simple, we'll write a check that does nothing more than send a
value of 1 for the metric `hello.world`. The configuration file will be very
simple, including no real information. This will go into `conf.d/hello.yaml`:

シンプルなオフを開始するためには、メトリックの1の値を送信するよりも、何もしません小切手書くつもりhello.worldを。設定ファイルには、本当の情報を含めていない、非常にシンプルになります。これはに入りますのconf.d / hello.yaml：


<%= snippet_code_block("guides-agentchecks-hello-config.yaml") %>

The check itself will inherit from `AgentCheck` and send a gauge of `1` for
`hello.world` on each call. This will go in `checks.d/hello.py`:

チェック自体から継承しAgentCheckとゲージ送る1をするため hello.world呼び出しごとに。これはに行くchecks.d / hello.py：

<%= snippet_code_block("guides-agentchecks-hello.py") %>

As you can see, the check interface is really simple and easy to get started
with. In the next section we'll write a more useful check that will ping HTTP
services and return interesting data.

ご覧のように、チェック·インタフェースは、本当にシンプルで使い始めるのは簡単です。次のセクションでは、HTTPサービスに対してpingを実行し、興味深いデータが返され、より有用な小切手を書きます。

<!--
======================================================
HTTP CHECK
======================================================
-->

<!-- <h3 id="http">An HTTP Check</h3>

Now we will guide you through the process of writing a basic check that will
check the status of an HTTP endpoint. On each run of the check, a GET
request will be made to the HTTP endpoint. Based on the response, one of the
following will happen:

  - If the response is successful (response is 200, no timeout) the response
  time will be submitted as a metric.
  - If the response times out, an event will be submitted with the URL and
  timeout.
  - If the response code != 200, an event will be submitted with the URL and
  the response code. -->


<h3 id="http">An HTTP Check</h3>

Now we will guide you through the process of writing a basic check that will
check the status of an HTTP endpoint. On each run of the check, a GET
request will be made to the HTTP endpoint. Based on the response, one of the
following will happen:

  - If the response is successful (response is 200, no timeout) the response
  time will be submitted as a metric.
  - If the response times out, an event will be submitted with the URL and
  timeout.
  - If the response code != 200, an event will be submitted with the URL and
  the response code.

HTTPチェック
今、私たちは、HTTPエンドポイントの状態をチェックします基本的なチェックを書き込む処理をガイドします。チェックを実行するたびに、GETリクエストは、HTTPエンドポイントについて説明する。応答に基づいて、次のいずれかが起こります：

応答が成功した場合（応答が200で、タイムアウトなし）応答時間がメトリックとして送信されます。
タイムアウト応答時間と、イベントがURLとタイムアウトで提出される。
応答コード！= 200場合、そのイベントは、URLおよびレスポンスコードで送信されます。



<!-- #### Configuration

First we will want to define how our configuration should look, so that we know
how to handle the structure of the `instance` payload that is passed into the
call to `check`.

Besides just defining a URL per call, it'd be nice to allow you to set a timeout
for each URL. We'd also want to be able to configure a default timeout if no
timeout value is given for a particular URL.

So our final configuration would look something like this:

<%= snippet_code_block("guides-agentchecks-ex-config.yaml") %> -->


#### Configuration

First we will want to define how our configuration should look, so that we know
how to handle the structure of the `instance` payload that is passed into the
call to `check`.

Besides just defining a URL per call, it'd be nice to allow you to set a timeout
for each URL. We'd also want to be able to configure a default timeout if no
timeout value is given for a particular URL.

So our final configuration would look something like this:

設定

まず私たちはの構造の処理方法を知っているように、私たちの構成がどのように見えるべきかを定義したいと思うでしょうインスタンスへの呼び出しに渡されるペイロードチェックを。

ちょうど呼び出しごとURLを定義するだけでなく、それはあなたが各URLのタイムアウトを設定できるようにいいだろうと思う。また、タイムアウト値が特定のURLのために指定されていない場合、デフォルトのタイムアウトを設定できるようにしたいと思います。

だから私たちの最終的な構成は次のようになります。


<%= snippet_code_block("guides-agentchecks-ex-config.yaml") %>

<!-- #### The Check

Now we can start defining our check method. The main part of the check will make
a request to the URL and time the response time, handling error cases as it goes.

In this snippet, we start a timer, make the GET request using the
[requests library](http://docs.python-requests.org/en/latest/) and handle and
errors that might arise.

<%= snippet_code_block("guides-agentchecks-ex-request.py") %>

If the request passes, we want to submit the timing to Datadog as a metric. Let's
call it `http.response_time` and tag it with the URL.

<%= snippet_code_block("guides-agentchecks-ex-metric.py") %>

Finally, we'll want to define what happens in the error cases. We have already
seen that we call `self.timeout_event` in the case of a URL timeout and
we call `self.status_code_event` in the case of a bad status code. Let's
define those methods now.

First, we'll define `timeout_event`. Note that we want to aggregate all of these
events together based on the URL so we will define the aggregation_key as a hash
of the URL.

<%= snippet_code_block("guides-agentchecks-ex-timeout.py") %>

Next, we'll define `status_code_event` which looks very similar to the timeout
event method.

<%= snippet_code_block("guides-agentchecks-ex-status.py") %> -->

#### The Check

Now we can start defining our check method. The main part of the check will make
a request to the URL and time the response time, handling error cases as it goes.

In this snippet, we start a timer, make the GET request using the
[requests library](http://docs.python-requests.org/en/latest/) and handle and
errors that might arise.

チェック

今、私たちは私たちのチェック方法の定義を開始することができます。チェックの主な部分は、それが行くようにエラーケースの処理、URLおよび時間応答時間に要求を行います。

このスニペットでは、タイマーを開始使用して、GET要求を行う リクエスト·ライブラリーをして処理し、発生する可能性のあるエラー。


<%= snippet_code_block("guides-agentchecks-ex-request.py") %>

If the request passes, we want to submit the timing to Datadog as a metric. Let's
call it `http.response_time` and tag it with the URL.

リクエストが合格した場合、当社は指標としてDatadogにタイミングを提出したいと思います。のは、それを呼びましょうhttp.response_timeとURLとそれにタグを付ける。


<%= snippet_code_block("guides-agentchecks-ex-metric.py") %>

Finally, we'll want to define what happens in the error cases. We have already
seen that we call `self.timeout_event` in the case of a URL timeout and
we call `self.status_code_event` in the case of a bad status code. Let's
define those methods now.

First, we'll define `timeout_event`. Note that we want to aggregate all of these
events together based on the URL so we will define the aggregation_key as a hash
of the URL.

最後に、エラーケースで何が起こるかを定義したいと思う。私たちは、すでに私たちが呼んでいることを見てきたself.timeout_eventを、URLのタイムアウトの場合には、私たちは呼んでself.status_code_eventを悪い状態コードの場合には。それでは、これらのメソッドを定義してみましょう。

まず、定義しますtimeout_eventを。私たちは、URLのハッシュとしてaggregation_keyを定義するように、一緒にされたURLに基づいて、これらのイベントのすべてを集約したいことに注意してください。


<%= snippet_code_block("guides-agentchecks-ex-timeout.py") %>

Next, we'll define `status_code_event` which looks very similar to the timeout
event method.

次に、定義しますstatus_code_eventタイムアウトイベントメソッドと非常によく似ています。

<%= snippet_code_block("guides-agentchecks-ex-status.py") %>


<!-- #### Putting It All Together

For the last part of this guide, we'll show the entire check. This module would
be placed into the `checks.d` folder as `http.py`. The corresponding
configuration would be placed into the `conf.d` folder as `http.yaml`.

Once the check is in `checks.d`, you can test it by running it as a python
script. **Make sure to change the conf.d path in the test method**. From your
Agent root, run:

    PYTHONPATH=. python checks.d/http.py

You'll see what metrics and events are being generated for each instance.

Here's the full source of the check:

<%= snippet_code_block("guides-agentchecks-ex-all.py") %>
 -->

#### Putting It All Together

For the last part of this guide, we'll show the entire check. This module would
be placed into the `checks.d` folder as `http.py`. The corresponding
configuration would be placed into the `conf.d` folder as `http.yaml`.

Once the check is in `checks.d`, you can test it by running it as a python
script. **Make sure to change the conf.d path in the test method**. From your
Agent root, run:

このガイドの最後の部分に関しては、全体のチェックを紹介します。このモジュールは、中に配置されることになるchecks.dのようにフォルダhttp.py。対応する構成は、中に配置されることになるのconf.dのようにフォルダhttp.yaml。

チェックがになったらchecks.d、あなたはPythonスクリプトとして実行して、それをテストすることができます。試験方法でのconf.dパスを変更してください。あなたのエージェントのルートから、次のコマンドを実行します


    PYTHONPATH=. python checks.d/http.py

You'll see what metrics and events are being generated for each instance.

Here's the full source of the check:

あなたは、インスタンスごとに生成されているかを評価指標とイベントが表示されます。

ここにチェックの完全なソースは次のとおりです。


<%= snippet_code_block("guides-agentchecks-ex-all.py") %>


<!--
======================================================
Troubleshooting
======================================================
-->

<!-- <h3 id="troubleshooting">Troubleshooting</h3>

Custom Agent checks can't be directly called from python and instead
 need to be called by the agent. To test this, run:

    sudo -u dd-agent dd-agent check my_check

If your issue continues, please reach out to Support with the help page that
 lists the paths it installs. -->

<h3 id="troubleshooting">Troubleshooting</h3>

Custom Agent checks can't be directly called from python and instead
 need to be called by the agent. To test this, run:

カスタムエージェントのチェックは、直接のpythonから呼び出され、代わりにエージェントによって呼び出される必要があることはできません。これをテストするには、実行します。

    sudo -u dd-agent dd-agent check my_check

If your issue continues, please reach out to Support with the help page that
 lists the paths it installs.

あなたの問題が解決しない場合、それはインストールパスが表示されますヘルプページをサポートするための手を差し伸べるしてください。

<!-- <h4>Testing Custom Checks on Windows</h4>

Testing custom checks on Windows is easy. The Agent install includes a file called shell.exe
in your Program Files directory for the Datadog Agent which you can use to run python within the Agent environment.

Once you're check (called "my_check") is written and you have the .py and .yaml files
in their correct places, you can run the following in shell.exe:

    >>> from checks import run_check
    >>> run_check('my_check')

This will output any metrics or events that the check will return. -->

<h4>Testing Custom Checks on Windows</h4>

Testing custom checks on Windows is easy. The Agent install includes a file called shell.exe
in your Program Files directory for the Datadog Agent which you can use to run python within the Agent environment.

Once you're check (called "my_check") is written and you have the .py and .yaml files
in their correct places, you can run the following in shell.exe:

Windows上でカスタムチェックのテストは簡単です。エージェントのインストールでは、エージェントの環境内でのpythonを実行するために使用できるDatadogエージェントについては、Program FilesディレクトリにSHELL.EXEというファイルが含まれています。

あなたが（「my_check」と呼ばれる）チェックが書かれているしていて、正しい場所での.pyと.yamlファイルを入手したら、SHELL.EXEで次のように実行できます。

    >>> from checks import run_check
    >>> run_check('my_check')

This will output any metrics or events that the check will return.

この意志出力チェックが返され、任意のメトリックやイベント。